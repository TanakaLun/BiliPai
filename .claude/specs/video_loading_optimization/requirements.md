# 视频加载优化需求文档

## 功能概述

本功能旨在优化 BiliPai 应用的视频加载体验，确保用户感知到的视频加载速度快，同时彻底杜绝"找不到视频播放地址"的情况。通过改进视频 URL 获取策略、添加预加载机制、增强错误处理和重试逻辑，以及优化缓存机制，来提升整体的视频播放可靠性和加载速度。

---

## 需求列表

### 1. 视频播放 URL 可靠性增强

**用户故事**：作为一名用户，我想要在任何情况下都能成功获取到视频播放地址，以便不会遇到"无法播放"的错误。

**验收标准**：

1.1 **[Ubiquitous]** 系统在请求视频播放 URL 时，**应当**首先检查本地缓存，如果缓存有效（未过期且格式正确）则直接使用缓存数据。

1.2 **[Event-Driven]** 当 WBI 签名密钥获取失败时，系统**应当**自动清除缓存并在 500ms 后重新获取，最多重试 3 次。

1.3 **[Event-Driven]** 当收到 HTTP 412（风控拦截）响应时，系统**应当**采用指数退避策略（500ms → 1.5s → 3s → 5s）重试请求。

1.4 **[Ubiquitous]** 系统在画质降级时，**应当**按照 120 → 80 → 64 → 32 → 16 的优先级链依次尝试，确保至少能播放一个画质版本。

1.5 **[Unwanted Behavior]** 系统**不应**在所有重试机制都失败后静默失败，而**应当**向用户显示明确的错误信息和建议操作（如"网络异常，请重试"或"请检查登录状态"）。

1.6 **[Event-Driven]** 当视频详情 API 返回空 CID 时，系统**应当**使用 bvid 重新请求视频详情，而不是立即报错。

1.7 **[Complex]** 如果用户已登录**且**请求的画质需要大会员，**则**系统**应当**自动降级到用户可用的最高画质，并通过 Toast 提示用户实际播放的画质。

---

### 2. 视频加载速度优化

**用户故事**：作为一名用户，我想要视频能尽快开始播放，以便减少等待时间，获得流畅的观看体验。

**验收标准**：

2.1 **[Ubiquitous]** 系统**应当**将视频播放 URL 缓存到内存中，缓存时间为 10 分钟，避免短时间内重复请求相同视频的播放地址。

2.2 **[Event-Driven]** 当用户点击视频卡片时，系统**应当**立即开始请求视频详情和播放 URL，在加载界面显示前就开始网络请求。

2.3 **[Ubiquitous]** 系统在获取 DASH 格式视频时，**应当**并行请求视频流和音频流的地址，而不是串行请求。

2.4 **[Event-Driven]** 当 ExoPlayer 开始缓冲时，系统**应当**显示加载进度指示器，当缓冲达到可播放阈值（默认 2 秒内容）时立即开始播放。

2.5 **[Optional Feature]** 如果用户在视频列表中停留超过 1 秒，系统**可以**预获取可见视频的播放 URL（最多 3 个），存储到缓存中供后续使用。

2.6 **[Ubiquitous]** 系统**应当**复用 OkHttp 连接池和 ExoPlayer DataSource，避免每次播放创建新的网络连接。

---

### 3. 错误处理与用户反馈

**用户故事**：作为一名用户，我想要在视频加载出错时获得清晰的反馈和解决方案，以便我知道下一步该怎么做。

**验收标准**：

3.1 **[Event-Driven]** 当视频加载失败时，系统**应当**根据错误类型显示不同的错误提示：

- 网络错误：显示"网络连接失败，请检查网络后重试"
- WBI 签名错误：显示"验证失败，正在重试..."
- 视频不存在：显示"视频不存在或已被删除"
- 地区限制：显示"该视频在当前地区不可用"

3.2 **[Ubiquitous]** 错误界面**应当**包含一个"重试"按钮，点击后重新执行完整的视频加载流程。

3.3 **[Event-Driven]** 当后台重试正在进行时，系统**应当**显示加载动画和进度提示（如"正在重试 2/4..."），让用户知道系统正在尝试恢复。

3.4 **[Unwanted Behavior]** 系统**不应**在用户没有明确操作的情况下无限重试，最多自动重试 4 次后停止并显示错误界面。

---

### 4. WBI 密钥管理优化

**用户故事**：作为一名用户，我想要 WBI 签名验证过程稳定可靠，以便不会因为签名问题导致视频无法播放。

**验收标准**：

4.1 **[Ubiquitous]** 系统**应当**将 WBI 密钥缓存到本地存储中，缓存有效期为 24 小时，减少对 `/nav` 接口的请求频率。

4.2 **[Event-Driven]** 当检测到 WBI 密钥已过期或签名验证失败时，系统**应当**立即刷新密钥并重试原请求。

4.3 **[Ubiquitous]** 系统在刷新 WBI 密钥时**应当**使用互斥锁，防止在并发场景下多次重复请求 `/nav` 接口。

4.4 **[Event-Driven]** 当应用从后台恢复到前台时，系统**应当**检查 WBI 密钥是否即将过期（剩余时间少于 1 小时），如果是则在后台预刷新密钥。

---

### 5. 视频播放连续性

**用户故事**：作为一名用户，我想要在切换画面或网络波动时视频能够无缝续播，以便不会丢失观看进度。

**验收标准**：

5.1 **[Event-Driven]** 当用户切换画质时，系统**应当**保存当前播放进度，在新画质加载完成后从该进度继续播放。

5.2 **[Event-Driven]** 当网络暂时中断后恢复时，系统**应当**自动继续播放，无需用户手动操作。

5.3 **[Ubiquitous]** 系统**应当**在播放过程中每 10 秒将当前进度保存到本地存储，以便在应用重启后恢复播放位置。

5.4 **[Event-Driven]** 当从小窗模式切换到全屏播放或视频详情页时，系统**应当**复用现有的 ExoPlayer 实例，保持播放状态不中断。

---

## 边缘情况考虑

- **无网络情况**：系统应在检测到无网络时立即提示，不进行无意义的重试
- **弱网络情况**：系统应适当延长超时时间，并可能自动降低画质
- **视频被删除/下架**：系统应识别 API 返回的特定错误码，显示对应提示
- **大会员专属视频**：系统应在非会员用户尝试播放时给出明确提示
- **分P视频**：系统应正确处理多 CID 的情况，确保切换分P时能快速获取播放地址
- **并发请求**：系统应处理用户快速切换视频的情况，取消之前未完成的请求

---

## 技术约束

- 必须兼容现有的 DASH 格式视频流处理
- 必须保持与 B 站 WBI 签名机制的兼容性
- 必须复用现有的 ExoPlayer 和 MiniPlayerManager 架构
- 缓存机制不应消耗过多内存（播放 URL 缓存上限 50 条）
- 重试机制不应阻塞主线程

---

## 成功标准

1. **可靠性**：视频播放 URL 获取成功率达到 99.9%
2. **加载速度**：从用户点击到视频开始播放的时间缩短 30%
3. **用户反馈**：消除"找不到播放地址"的错误出现
4. **错误恢复**：90% 的临时性错误能在自动重试后成功恢复
